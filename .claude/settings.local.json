{
  "permissions": {
    "allow": [
      "Bash(python:*)",
      "Bash(npm run build:*)",
      "Bash(/c/Users/Usuario02/AppData/Local/Programs/Python/Python312/python.exe:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(npx next build:*)",
      "Bash(node -e:*)",
      "Bash(git rm:*)",
      "Bash(git ls-tree:*)",
      "Bash(npx vitest run:*)",
      "WebFetch(domain:docs.google.com)",
      "Bash(npm test:*)",
      "Bash(npm run test:formulas:*)",
      "Bash(npm run:*)",
      "Bash(find:*)",
      "Bash(powershell -Command:*)",
      "Bash(\"d:\\\\aoe-v2\\\\src\\\\app\\\\api\\\\webhooks\\\\payment\\\\route.ts\" << 'EOFMARKER'\nimport { NextRequest, NextResponse } from 'next/server'\nimport { createAdminClient } from '@/lib/supabase/admin'\nimport { payphoneWebhookSchema, isPaymentApproved } from '@/lib/validations/payment'\nimport { PRECIO_CONTRATO_BASICO } from '@/lib/formulas/vehicular'\n\nexport async function POST\\(request: NextRequest\\) {\n  try {\n    const body = await request.json\\(\\)\n    console.log\\('[PayPhone Webhook] Received:', body\\)\n\n    const validated = payphoneWebhookSchema.safeParse\\(body\\)\n    if \\(!validated.success\\) {\n      console.error\\('[PayPhone Webhook] Invalid payload:', validated.error\\)\n      return NextResponse.json\\(\n        { error: 'Invalid payload' },\n        { status: 400 }\n      \\)\n    }\n\n    const payload = validated.data\n    const contractId = payload.clientTransactionId.split\\('-'\\)[0]\n    if \\(!contractId\\) {\n      console.error\\('[PayPhone Webhook] Invalid clientTransactionId'\\)\n      return NextResponse.json\\(\n        { error: 'Invalid clientTransactionId' },\n        { status: 400 }\n      \\)\n    }\n\n    const supabase = createAdminClient\\(\\)\n    const { data: contract, error: fetchError } = await supabase\n      .from\\('contracts'\\)\n      .select\\('*'\\)\n      .eq\\('id', contractId\\)\n      .single\\(\\)\n\n    if \\(fetchError || !contract\\) {\n      console.error\\('[PayPhone Webhook] Contract not found:', contractId\\)\n      return NextResponse.json\\(\n        { error: 'Contract not found' },\n        { status: 404 }\n      \\)\n    }\n\n    if \\(\n      isPaymentApproved\\(payload.statusCode\\) &&\n      \\(contract.status === 'DRAFT' || contract.status === 'PENDING_PAYMENT'\\)\n    \\) {\n      console.log\\('[PayPhone Webhook] Processing payment for contract:', contractId\\)\n      await supabase\n        .from\\('contracts'\\)\n        .update\\({\n          status: 'PAID',\n          payment_id: payload.id,\n          amount: PRECIO_CONTRATO_BASICO,\n        }\\)\n        .eq\\('id', contractId\\)\n\n      return NextResponse.json\\({\n        success: true,\n        message: 'Payment processed successfully',\n      }\\)\n    }\n\n    console.log\\('[PayPhone Webhook] Payment status:', payload.status, 'Contract status:', contract.status\\)\n    return NextResponse.json\\({\n      success: true,\n      message: 'Webhook received',\n    }\\)\n  } catch \\(error\\) {\n    console.error\\('[PayPhone Webhook] Error:', error\\)\n    return NextResponse.json\\(\n      {\n        error: error instanceof Error ? error.message : 'Internal server error',\n      },\n      { status: 500 }\n    \\)\n  }\n}\nEOFMARKER)",
      "Bash(npx vitest:*)",
      "Bash(dir:*)",
      "Bash(findstr:*)"
    ]
  }
}
